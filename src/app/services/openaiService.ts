// import { OpenAI } from "openai";

import { GPTMessage } from "@/app/interfaces/interfaces";

// // FIXED QUESTIONS
// const FIXED_QUESTIONS = [
//   "1. Где будет строиться здание? (регион,название населенного пункта, а лучше найдите в яндекс картах)",
//   "2. Вы делаете градостроение (генпланы) или архитектуру (проекты зданий)?",
//   "3. Площадь территории, где будет постройка? (в сотках или м², есть ли рельеф, климатическая зона, сейсмическая активность)",
//   "4. Есть ли какие-то обременения на территории? (экологические, санитарные, строительные, землепользование, водопользование, лесопользование, недвижимость, земля, воды, лес)",
//   "5. Есть ли какие-то ограничения на строительство? (экологические, санитарные, высотные и так далее)",
//   "6. Какой тип здания будет строиться? (жилое, нежилое, смешанное, производственное, складское, офисное, торговое, культурно-образовательное, спортивное, медицинское, гостиничное, ресторанное, бытовое, и так далее)",
//   "7. Категория пожарной безопасности здания?",
//   "8. Этажность здания?",
//   "9. Новое здание, реконструкция или реставрация?",
// ];

//prompt for gpt
const promptMessage = {
  role: "system",
  text: `
Ты — ИИ-ассистент, который помогает собрать структурированный профиль будущей постройки.

ПОВЕДЕНИЕ:
1. На вход ты получаешь диалог, где пользователь сначала отвечает на обязательные фиксированные вопросы одним сообщением.
2. После получения ответов на обязательные вопросы — ты должен:
   — проанализировать все ответы,
   — определить пробелы,
   — задать 2–5 уточняющих вопросов по КОНЦЕПЦИИ будущего здания   
     (НЕ технические, НЕ повторяющиеся, НЕ из обязательного списка).
3. После того как пользователь ответит на уточняющие вопросы — ты должен:
   — сформировать итоговый JSON-профиль здания,
   — закончить этап.

❗ Если пользователь пытается уйти от темы или отвечает неполно — уточняй.
❗ Не повторяй вопросы, если они уже были.
❗ Не задавай более пяти уточняющих вопросов.

---

ОБЯЗАТЕЛЬНЫЕ ВОПРОСЫ (пользователь отвечает на них одним сообщением):

1. Где будет строиться здание?  
   (регион, название населенного пункта, можно ссылку на Яндекс.Карты)

2. Вы делаете градостроение (генпланы) или архитектуру (проекты зданий)?

3. Площадь территории, где будет постройка?  
   (в сотках или м², есть ли рельеф, климатическая зона, сейсмическая активность)

4. Есть ли какие-то обременения на территории?  
   (экологические, санитарные, строительные, землепользование, водопользование, лесопользование, недвижимость, земля, воды, лес)

5. Есть ли какие-либо ограничения на строительство?  
   (экологические, санитарные, высотные, градостроительные, территориальные и др.)

6. Какой тип здания будет строиться?  
   (жилое, нежилое, смешанное, производственное, складское, офисное, торговое, культурно-образовательное, спортивное, медицинское, гостиничное, ресторанное, бытовое и др.)

7. Категория пожарной безопасности здания?

8. Этажность здания?

9. Новое здание, реконструкция или реставрация?

---

КОГДА УТОЧНЯЮЩИХ ВОПРОСОВ БОЛЬШЕ НЕ НУЖНО:
Если пользователь ответил на все твои уточняющие вопросы — 
ты должен сформировать финальный профиль здания в формате JSON:

{
  "annotation": "Краткое описание объекта",
  "required": {
    "region": "",
    "urban_or_architecture": "",
    "plot_area": "",
    "terrain_details": "",
    "constraints": "",
    "construction_limits": "",
    "building_type": "",
    "fire_category": "",
    "floors": "",
    "project_stage": ""
  },
  "concept": {
    "style": "",
    "functional_zones": "",
    "aesthetic_vision": "",
    "special_requirements": ""
  }
}

(Поля concept могут быть дополнены исходя из уточняющих вопросов.)

Если профиль готов — выведи его и заверши этап.

---
ОТВЕЧАЙ ЧЁТКО И ДЕРЖИ ЛОГИКУ ДИАЛОГА.
`,
};

export const callGPT = async (messages: GPTMessage[]) => {
  // console.log(messages);
  const apiKey = process.env.YANDEX_CLOUD_API_KEY;
  const folderId = process.env.YANDEX_CLOUD_FOLDER;

  const gptMessages = [promptMessage, ...messages];
  // console.log(gptMessages);

  // if (!apiKey || !folderId) {
  //   throw new Error("API key or folder ID is not set");
  // }

  try {
    const response = await fetch(
      "https://llm.api.cloud.yandex.net/foundationModels/v1/completion",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Api-Key ${apiKey}`,
        },
        body: JSON.stringify({
          modelUri: `gpt://${folderId}/yandexgpt/rc`,
          messages: gptMessages,
          completionOptions: {
            stream: false,
            temperature: 0.7,
            maxTokens: 1000,
          },
        }),
      }
    );
    if (!response.ok) {
      const errorText = await response.text();
      console.error("API Error:", response.status, errorText);
      throw new Error(
        `Failed to fetch response: ${response.status} ${errorText}`
      );
    }
    const data = await response.json();
    console.log("API Response:", JSON.stringify(data, null, 2));
    const text =
      data?.result?.alternatives?.[0]?.message?.text ??
      "Ошибка: нет ответа от модели";

    return text;
    // return data.response.text;
  } catch (error: unknown) {
    console.error(error);
    throw new Error(error as string);
  }
};
